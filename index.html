<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 Cud√≥w ≈öwiata: skaner kart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; color: #212529; padding-bottom: 120px; }
        
        .image-container { 
            position: relative; 
            width: 100%; 
            max-width: 640px; 
            margin: 0 auto; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            background: #e9ecef;
            min-height: 250px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer; 
            transition: background 0.3s;
            border: 2px dashed #ced4da;
        }
        
        .image-container:hover { background: #dee2e6; border-color: #adb5bd; }
        
        canvas { width: 100%; height: auto; display: block; }

        #cameraInput { display: none; }
        .placeholder-text { color: #6c757d; text-align: center; padding: 20px; }
        
        .score-input { 
            border: 1px solid #dee2e6; 
            background-color: #fff; 
            font-weight: bold; 
            font-size: 1.3rem; 
            text-align: center;
            border-radius: 8px;
        }
        .score-input:focus {
            box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.25);
            border-color: #198754;
        }

        .score-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 4px;
            display: block;
            white-space: nowrap;
        }

        .btn-action {
            height: 60px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .key-reset {
            font-size: 0.75rem;
            color: #adb5bd;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 15px;
            display: inline-block;
            padding: 10px;
        }
    </style>
</head>
<body>

<div class="container mt-3">
    <h3 class="text-center mb-4 fw-bold text-secondary">üèõÔ∏è 7 Cud√≥w ≈öwiata: skaner kart</h3>

    <button id="mainBtn" class="btn btn-primary w-100 btn-action mb-3 rounded-pill" onclick="openCamera()">
        üì∏ Zr√≥b zdjƒôcie kart
    </button>
    
    <div id="status" class="text-center fw-bold text-primary mb-3 small" style="min-height: 24px;"></div>

    <div class="image-container mb-3 d-none" id="imgBox" onclick="openCamera()">
        <div id="placeholder" class="placeholder-text"></div>
        <canvas id="canvas"></canvas>
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" onchange="handleFile(this)">

    <div class="card border-success mb-3 shadow-sm mt-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <span class="fw-bold">üß™ Nauka</span>
            <span class="badge bg-white text-success fs-6" id="scienceScore">0 pkt</span>
        </div>
        <div class="card-body bg-light">
            <div class="row g-2 text-center">
                <div class="col-4">
                    <label class="score-label">Ko≈Ça ‚öôÔ∏è</label>
                    <input type="number" id="gears" class="form-control score-input" value="0" oninput="calculate()">
                </div>
                <div class="col-4">
                    <label class="score-label">Cyrkle üß≠</label>
                    <input type="number" id="compass" class="form-control score-input" value="0" oninput="calculate()">
                </div>
                <div class="col-4">
                    <label class="score-label">Tablice üìú</label>
                    <input type="number" id="tablets" class="form-control score-input" value="0" oninput="calculate()">
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-5 border-0 shadow-sm">
        <div class="card-body bg-white rounded border">
            <h6 class="text-muted small text-uppercase mb-3 fw-bold text-center">Pozosta≈Çe punkty</h6>
            
            <div class="row g-3 text-center">
                <div class="col-4"><label class="score-label">Militaria ‚öîÔ∏è</label><input type="number" id="military" class="form-control score-input" value="0" oninput="calculate()"></div>
                <div class="col-4"><label class="score-label">Monety üí∞</label><input type="number" id="coins" class="form-control score-input" value="0" oninput="calculate()"></div>
                <div class="col-4"><label class="score-label">Cuda üèóÔ∏è</label><input type="number" id="wonders" class="form-control score-input" value="0" oninput="calculate()"></div>
                <div class="col-4"><label class="score-label">Cywilne üèõÔ∏è</label><input type="number" id="blue" class="form-control score-input" value="0" oninput="calculate()"></div>
                <div class="col-4"><label class="score-label">Handel ‚ö±Ô∏è</label><input type="number" id="yellow" class="form-control score-input" value="0" oninput="calculate()"></div>
                <div class="col-4"><label class="score-label">Gildie üü£</label><input type="number" id="guilds" class="form-control score-input" value="0" oninput="calculate()"></div>
            </div>
        </div>
    </div>

    <div class="fixed-bottom bg-white border-top p-3 shadow-lg text-center">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-secondary fw-bold fs-5">SUMA:</span>
            <span id="totalScore" class="text-primary fw-bold" style="font-size: 2.5rem;">0</span>
        </div>
        <div id="keyStatus" class="small text-muted mb-1"></div>
        <span class="key-reset" onclick="resetApiKey()">Kliknij tutaj, aby zmieniƒá klucz API</span>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const PROJECT_NAME = "7-wotw-card-scanner";
    const VERSION = 1; 
    
    let API_KEY = ""; 

    // ZarzƒÖdzanie kluczem
    function checkApiKey() {
        const storedKey = localStorage.getItem("roboflow_key_cardscanner");
        const statusLabel = document.getElementById('keyStatus');
        
        if (storedKey) {
            API_KEY = storedKey;
            statusLabel.innerText = "Za≈Çadowano klucz: ..." + API_KEY.slice(-4);
        } else {
            statusLabel.innerText = "Brak klucza API";
            setTimeout(() => {
                const userKey = prompt("Wklej prywatny klucz API Roboflow:");
                if (userKey && userKey.trim() !== "") {
                    localStorage.setItem("roboflow_key_cardscanner", userKey.trim());
                    API_KEY = userKey.trim();
                    statusLabel.innerText = "Za≈Çadowano klucz: ..." + API_KEY.slice(-4);
                    alert("Klucz zapisany!");
                }
            }, 500);
        }
    }

    function resetApiKey() {
        if(confirm("Czy na pewno chcesz usunƒÖƒá klucz i wpisaƒá nowy?")) {
            localStorage.removeItem("roboflow_key_cardscanner");
            location.reload();
        }
    }

    checkApiKey();
    
    // ------------------------------------

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    const cameraInput = document.getElementById('cameraInput');
    const placeholder = document.getElementById('placeholder');
    const mainBtn = document.getElementById('mainBtn');
    const imgBox = document.getElementById('imgBox');

    function openCamera() {
        if(!API_KEY) {
            alert("Brak klucza API. Od≈õwie≈º stronƒô i wpisz klucz.");
            return;
        }
        cameraInput.click();
    }

    function handleFile(input) {
        if (input.files && input.files[0]) {
            imgBox.classList.remove('d-none');
            const file = input.files[0];
            statusDiv.innerText = "‚è≥ Przetwarzanie...";
            placeholder.style.display = 'none';

            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                mainBtn.innerText = "üîÑ Zr√≥b nowe zdjƒôcie";
                mainBtn.className = "btn btn-outline-primary w-100 btn-action mb-3 rounded-pill";
                sendToAI(img);
            };
            img.src = URL.createObjectURL(file);
        }
    }

    async function sendToAI(imgElement) {
        statusDiv.innerText = "‚è≥ Analiza AI...";

        let scale = 1.0;
        if(imgElement.width > 2000) scale = 0.5;

        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = imgElement.width * scale;
        tempCanvas.height = imgElement.height * scale;
        tempCanvas.getContext('2d').drawImage(imgElement, 0, 0, tempCanvas.width, tempCanvas.height);
        
        const imageBase64 = tempCanvas.toDataURL("image/jpeg", 0.85).split(',')[1];
        
        // URL z nowƒÖ nazwƒÖ projektu
        const url = `https://detect.roboflow.com/${PROJECT_NAME}/${VERSION}?api_key=${API_KEY}`;

        try {
            const response = await axios({
                method: "POST",
                url: url,
                data: imageBase64,
                headers: { "Content-Type": "application/x-www-form-urlencoded" }
            });

            processResults(response.data.predictions, scale);

        } catch (error) {
            console.error(error);
            if (error.response) {
                 // Wy≈õwietlamy konkretny b≈ÇƒÖd
                 statusDiv.innerText = `‚ùå B≈ÇƒÖd serwera: ${error.response.status}. Sprawd≈∫ nazwƒô projektu i klucz.`;
                 if(error.response.status === 404) {
                     statusDiv.innerText += " (Nie znaleziono projektu 'card-scanner')";
                 }
            } else {
                statusDiv.innerText = "‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: " + error.message;
            }
        }
    }

    function processResults(predictions, scale) {
        let counts = { gear: 0, compass: 0, tablet: 0 };

        predictions.forEach(p => {
            const x = (p.x / scale) - (p.width / scale) / 2;
            const y = (p.y / scale) - (p.height / scale) / 2;
            const w = p.width / scale;
            const h = p.height / scale;
            
            ctx.strokeStyle = "#198754"; 
            ctx.lineWidth = 12;
            ctx.strokeRect(x, y, w, h);

            const cls = p.class.toLowerCase();
            if (cls.includes('gear') || cls.includes('kolo')) counts.gear++;
            if (cls.includes('compass') || cls.includes('cyrkiel')) counts.compass++;
            if (cls.includes('tablet') || cls.includes('tabliczka')) counts.tablet++;
        });

        document.getElementById('gears').value = counts.gear;
        document.getElementById('compass').value = counts.compass;
        document.getElementById('tablets').value = counts.tablet;

        if (predictions.length > 0) {
            statusDiv.innerText = `‚úÖ Znaleziono: ${predictions.length}`;
            statusDiv.className = "text-center fw-bold text-success mb-3";
        } else {
            statusDiv.innerText = "ü§∑‚Äç‚ôÇÔ∏è Nic nie znaleziono.";
            statusDiv.className = "text-center fw-bold text-warning mb-3";
        }
        
        calculate();
    }

    function calculate() {
        let g = parseInt(document.getElementById('gears').value) || 0;
        let c = parseInt(document.getElementById('compass').value) || 0;
        let t = parseInt(document.getElementById('tablets').value) || 0;
        let mil = parseInt(document.getElementById('military').value) || 0;
        let coins = parseInt(document.getElementById('coins').value) || 0;
        let won = parseInt(document.getElementById('wonders').value) || 0;
        let blue = parseInt(document.getElementById('blue').value) || 0;
        let yel = parseInt(document.getElementById('yellow').value) || 0;
        let gui = parseInt(document.getElementById('guilds').value) || 0;

        let science = (g*g) + (c*c) + (t*t) + (Math.min(g, c, t) * 7);
        document.getElementById('scienceScore').innerText = science + " pkt";
        let total = science + mil + Math.floor(coins/3) + won + blue + yel + gui;
        document.getElementById('totalScore').innerText = total;
    }
</script>

</body>
</html>
